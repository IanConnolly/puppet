#!/usr/bin/env python
# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at http://mozilla.org/MPL/2.0/.
# Make sure runner runs at boot

import os
import subprocess

import logging
log = logging.getLogger(__name__)


BUILDSLAVE_CMD = '/tools/buildbot/bin/buildslave'
RUNSLAVE = '/usr/local/bin/runslave.py'
# use the python from the buildbot virtualenv
PYTHON = '/tools/buildbot/bin/python'
BUILD_USER = "<%= scope.lookupvar('::config::builder_username') %>"


def main():
    logging.basicConfig(format="%(asctime)s - %(levelname)s - %(message)s")

    print "buildbot " + str(os.path.isfile(BUILDSLAVE_CMD)
                            and os.access(BUILDSLAVE_CMD, os.X_OK))

    if not (os.path.isfile(BUILDSLAVE_CMD)
            and os.access(BUILDSLAVE_CMD, os.X_OK)):
        exit(0)

    print "buildbot: before"
    p = subprocess.Popen(['su', '-', BUILD_USER, '-c', PYTHON + ' ' + RUNSLAVE])
    print "buildbot: started"
    p.wait()
    exit(0)



if __name__ == '__main__':
    main()

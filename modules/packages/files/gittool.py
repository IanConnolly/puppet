#!/usr/bin/env python
### Compressed module sources ###
module_sources = [('util', 'eJxlkM0KwjAQhO99iqWnClJQigfBl/AsSNJsmwWblOzWvr5N4l81t2RnZ+YLDaMPAlaxvZHegian\nuCUqCoMdsFU7lkCur3hzLGA55RllCg7EYhqnVfBdfkha4DJJQ1Y+veuoXmxqQz2yVJscoQ/NnzeD\nVoyHBtC13qDZwkxiQRTdov1sSZBH1SIoZ+C0BA3+jmaV+gKp9V5ds10MD7HiWJWniys/DRLnNPwW\n4QS17gJ3DEzevZHzaryusRPY9/8tcQ8W+3WH\n'), ('util.file', 'eJzNVk1v4zYQvftXTF0EkQNXbYz2soAPRVpgCxTbYre3xcKhRcriRiIFkoqTf983pL4iZ/ewp/Uh\ndjgzj/Nm3oy0Xq/fqrpVjsrOFEFb4ylYqoSRtaJS44+FVUTLer1e6aa1LlBtTydtTluyfku+6oKu\nt4jyVa2PWwqqaTl2VTrb0J01pT79K5zHNX38e3GeH6+AR/sBNT+p8Dd+KpcdDkY06nDYrFZSlVTY\nphVOZQx+u4357TZvVoQPkuutYFApuJqgTPBkSwpnG32Rayu8V5K0IaXh5kj4GI4PiJpEOdFHKMxF\nobzXx6EarQiVz+kPC7MgDzqg2QMYoR8V+eDAoU9Ve2tQIEvSkrGBOo+CGqqFO3HNOSeuKkfrkrTX\nxgdhipHhUXiVAHua/Ik2lIsTHhyv3fWW/nOd2nwBbPcVsN0cbHcBFq84jAXdp4PcKSGzyWO39NjN\nPZwKnTMXUPtFaGqz1E4VwbpnaCQI0MjGExSzK0v9NHWd3ifogHyZNzf/hEaYCSaKgXGisXX2UUuI\n4KxrWQgnI1KC3XJLNdrDU3Bfeyqt/fnmKNw9DX2qdABBYZ6zj2WujPRnCCnrs4I/2srysj6vtQ/I\nYUp+82nsDosBSFMfoP1cOWddtr6zXS2jR6mNpJsrz4BXfk1XlA15TqAvCgzMYVTaZ65t5l0Bbx+2\n8aixUu1ja8cC3uGY4MWUo1+LGVLukVWM2W809M97AUNBQTcQvi5HLMgsKmWoTtoF+cXtI/EhcGI+\nC2HDImThAUWHmUek6itx67smKydOgybQ7g9vf//pNu6muAoWqyEO9X15v+USV+qJG9iIMDYbre7X\nWs7XDHpvx4nhaTlep+NzxWhcjondsbbFA09Em8bht9vdze0vu18ndr0aouMUF2MR8TCeVHnXShFU\nFj1fdj1H6lKfMN7ZUBRRqkNnam0e4ljzHp3qkww0GEifjHWGOx416IdBiuWRWHbmOpB6gqCHygT3\n/GZOAXrn3Zhrz5Jf3DguG0yHszZE+fq0wH0/LWdRT5niGWJbac9mrtUlUpyzCHFpn7rU5/XZapOl\nu8vNq+4vKtZe+gDJNUyOUSazqr16eT8cl4WPdvVUqDbQPx/+5BpvaRb2I/3FHVC0fmexioqqf/a6\nac7X82or3hXG8gLdvbw8KeIr2TmhvZppZDGqkNAkE3aon+PMjhsCDniMsVREfNBbJ7BhNUbKNUpq\nCDRtigob2DF7uCbFpOBBQKVEk5s2ym8/vjLkzYPn37w090Pv8Jvdspjc5rU9Y4+fsziPkUScSH43\nyUuZphR3XZ9xeBE87ZM+l+TBvY6dy/rjvjKrVLjaCsnPLLzALKWeTsFo8YqTzTYgn6Zt8HGI/rSh\nH/Y0/Tv1rB/xd9ao+cgnlD4fvDAN6aQvPMdUfJ1DFdr0DT/R1UNzpzyw3g69c9Z/b2IHZ/aEkS0w\nNxdJ9iFI58J3nnufykXyB6joeyHAqXwTh6O19fdCgnNR4jLkNSL/A0blzyc=\n'), ('util.commands', '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\nD6Mr0w==\n'), ('util.retry', 'eJyNVsuu2zYQXVdfMXBxYdkVBN8ANwsjLlIUTVCgyCrLADYlUTYRiXT5iHNR9N87Q1LUw25RL2xy\nODycMzwzpuivSluwoudZq1UPrZO1VaozIMLSTbOryeLEalbzitVfs8HSqfNZyHOGv3AYZuWZ2z9w\nyHV+PErW8+Nxk2UNb0Fzq19zVluhZAHMWt5frTm8FGA6zq8Ux+HtroCefT+Olpct2fzeI/9ek1VJ\nc8h/G8bFpsggfeqOM+muh09KcjxEn9F1U8DXmx/+9fdm751Xq9WvrOvgFMJZA6NjRe96UC1aY3Br\nnx0DTlrRgbBgXF1z3pjxSGTGXGeROVgFLyWcUuxrEAbshYN0fcU1IRteK9kYcr0xYbMfKm5vnMuU\njmIB+HYHTDbQKFd1ZOKsvoRsDFsKdEvRzGnMMrkuAU7LPPoQGVh37ThuSTgpu0SAIe+Lcl0DFYea\nufPFlvB7CyMMKKSpyVXilzI8AXXCWN6AkI/OZpqDZsKggxfgcBsFZe0VbgJvqBqxoqvoe94IZnn3\n6sM4xTv3XK5afRMNelHWarxiViEzvDkCS0ieR9fNwYC1FkkghcSeEAfCnxTJyfVcWpOAYohwZYZC\nwwsTITevyulBjKGwCE7zP53QKKh7JAwRD9OoD4xIEgOfeMTxZejXJQU3bO24MQm5TDgnEvra0z8F\n1Yc8D5fs1SRqSwJJUVDgRAGUnIgJjachhWusGL9ARLH2B3us5810TSqbqCs9ukZb8BXtvNDh3dgG\n9qN81LlseOXO+Wru/dSAT4CX3NS8gifIZ76T/rIJZ0tsV89+dLsIzImEd4dUgePhKNf9pLWEaIRs\nVb7yWt4D9RCqyieDSrAX32/2OBsaThhHZPgxRPdlhgmQWqKxOqddmzAMEDiRMexUB9w6jULw2/It\neRWw3Ub/5Boq7a513lOKCU6cSO9jce9hVdDsSMwPn7Xj82jwIuPF7hfEUjfO73bgDTzK+L8m+qP4\nRnkmQUnMKaVxKrxZdqhLLM8bFfIz7P7HeR8Y6qKJyvE33KTeXfFWUeMiT1yiWEaB3UGTtfTr+X94\njfEdJuMtvLnzXJCZKf2e2BJ75j7zRm74n+NGYyskqntRARJ+otJJ/+fCF/Y2aGwQYphFOYb96/Ua\nfsG/tlppZrEnYAbje2BTYrtlPbUmZ9g5cng/godk0YGtUhMllWWZLX3To+J5t5s+K553I0rFdL7Z\nz2BihFnyOSbIY4s6UxgnddrJtvf+bRSs07fAdCu5XPEdtKzQ/aNqDtkgvPhsCZviwyX8IMYk0w8v\n238WV5AtjroPMXu8Grln/wDA0B8t\n'), ('util.git', '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\nL27HoQ9BZ1k4b/V+Mh39G58WnCU=\n')]

### Load the compressed module sources ###
import sys, imp
for name, source in module_sources:
    source = source.decode("base64").decode("zlib")
    mod = imp.new_module(name)
    exec source in mod.__dict__
    sys.modules[name] = mod

### Original script follows ###
#!/usr/bin/python
"""%prog [-p|--props-file] [-r|--rev revision] [-b|--branch branch]
         [-s|--shared-dir shared_dir] repo [dest]

Tool to do safe operations with git.

revision/branch on commandline will override those in props-file"""

# Import snippet to find tools lib
import os
import site
site.addsitedir(os.path.join(os.path.dirname(os.path.realpath(__file__)),
                             "../../lib/python"))

from util.git import git

if __name__ == '__main__':
    from optparse import OptionParser
    import logging

    parser = OptionParser(__doc__)
    parser.set_defaults(
        revision=os.environ.get('GIT_REV'),
        branch=os.environ.get('GIT_BRANCH', None),
        propsfile=os.environ.get('PROPERTIES_FILE'),
        loglevel=logging.INFO,
        shared_dir=os.environ.get('GIT_SHARE_BASE_DIR'),
        mirrors=None,
    )
    parser.add_option("-r", "--rev", dest="revision", help="which revision to update to")
    parser.add_option("-b", "--branch", dest="branch", help="which branch to update to")
    parser.add_option("-p", "--props-file", dest="propsfile",
                      help="build json file containing revision information")
    parser.add_option("-s", "--shared-dir", dest="shared_dir",
                      help="clone to a shared directory")
    parser.add_option("--mirror", dest="mirrors", action="append",
                      help="add a mirror to try cloning/pulling from before repo")
    parser.add_option("-v", "--verbose", dest="loglevel", action="store_const", const=logging.DEBUG)

    options, args = parser.parse_args()

    logging.basicConfig(level=options.loglevel, format="%(asctime)s %(message)s")

    if len(args) not in (1, 2):
        parser.error("Invalid number of arguments")

    repo = args[0]
    if len(args) == 2:
        dest = args[1]
    else:
        dest = os.path.basename(repo)

    # Parse propsfile
    if options.propsfile:
        try:
            import json
            assert json
        except ImportError:
            import simplejson as json

        js = json.load(open(options.propsfile))
        if options.revision is None:
            options.revision = js['sourcestamp']['revision']
        if options.branch is None:
            options.branch = js['sourcestamp']['branch']

    got_revision = git(repo, dest, options.branch, options.revision,
                       shareBase=options.shared_dir,
                       mirrors=options.mirrors,
                       )

    print "Got revision %s" % got_revision
